{% load static %}
<section id="cursos" class="relative py-12 bg-white overflow-hidden font-['Plus_Jakarta_Sans',_sans-serif]">
    
    <div class="absolute inset-0 z-0 pointer-events-none">
        <div class="absolute top-0 left-0 w-[30%] h-[300px] bg-slate-50/50" style="clip-path: polygon(0 0, 100% 0, 0 100%);"></div>
        <div class="absolute bottom-0 right-0 w-[20%] h-[200px] bg-slate-50/30" style="clip-path: polygon(100% 0, 100% 100%, 0 100%);"></div>
    </div>

    <div class="container mx-auto px-6 relative z-10">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4 border-b border-slate-100 pb-5">
            <div class="flex items-center gap-4">
                <h2 class="text-3xl font-black text-[#00112b] tracking-tighter uppercase leading-none">
                    Catálogo <span class="text-[#ff0022]">2026</span>
                </h2>
                <span class="hidden md:block w-[1px] h-6 bg-slate-200"></span>
                <span class="text-[9px] font-bold uppercase tracking-[0.3em] text-slate-400">Selección Elite</span>
            </div>
            <button onclick="openCatalogModal()" class="group flex items-center gap-3 text-[9px] font-black uppercase tracking-widest text-[#00112b] hover:text-[#ff0022] transition-colors">
                Explorar Todo
                <span class="w-7 h-7 rounded-full border border-slate-200 flex items-center justify-center group-hover:border-[#ff0022] group-hover:bg-[#ff0022] group-hover:text-white transition-all text-xs">→</span>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-10">
            {% for curso in cursos|slice:":4" %}
            <div class="group relative flex flex-col cursor-pointer" onclick="cargarDetalleModal('{{ curso.slug }}')">
                
                <div class="relative perspective-1000 mb-4">
                    <div class="relative aspect-[3/3.8] w-full transition-transform duration-500 preserve-3d group-hover:[transform:rotateY(-12deg)]">
                        
                        <div class="absolute inset-y-0 -left-[4px] w-[4px] bg-[#00112b] origin-right [transform:rotateY(-90deg)] group-hover:bg-[#ff0022] transition-colors"></div>

                        <div class="relative w-full h-full bg-slate-50 shadow-[15px_15px_35px_-15px_rgba(0,0,0,0.12)] overflow-hidden" 
                             style="clip-path: polygon(0 0, 100% 0, 97% 100%, 0 100%);">
                            <img src="{{ curso.portada.url }}" 
                                 class="w-full h-full object-cover grayscale-[0.2] group-hover:grayscale-0 transition-all duration-700"
                                 alt="{{ curso.titulo }}">
                            
                            <div class="absolute top-3 left-3">
                                <span class="bg-[#00112b]/90 backdrop-blur-sm text-white text-[7px] font-black px-2 py-1 uppercase tracking-widest">
                                    {{ curso.get_nivel_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col px-1">
                    <div class="flex items-center justify-between mb-1.5">
                        <span class="text-[9px] font-mono text-slate-300">#0{{ forloop.counter }}</span>
                        <span class="text-xs font-black text-[#00112b]">S/ {{ curso.precio_principal }}</span>
                    </div>

                    <h3 class="text-base font-black text-[#00112b] leading-tight mb-2 uppercase tracking-tight group-hover:text-[#ff0022] transition-colors line-clamp-1">
                        {{ curso.titulo }}
                    </h3>

                    <p class="text-[10px] text-slate-500 leading-relaxed mb-4 font-medium h-8 border-l border-slate-100 pl-3">
                        {{ curso.descripcion|truncatechars:50 }}
                    </p>

                    <div class="flex items-center justify-between pt-3 border-t border-slate-50">
                        <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-full overflow-hidden grayscale border border-slate-100">
                                <img src="{{ curso.instructor.foto.url }}" class="w-full h-full object-cover">
                            </div>
                            <span class="text-[8px] font-bold text-slate-400 uppercase">
                                {{ curso.instructor.nombre|truncatechars:15 }}
                            </span>
                        </div>
                        <div class="flex items-center gap-1 text-[8px] font-black text-[#00112b]">
                            <span class="text-[#ff0022] tracking-tighter">{{ curso.horas_certificacion }}H</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<style>
    .perspective-1000 { perspective: 1000px; }
    .preserve-3d { transform-style: preserve-3d; }
    /* Estética de texto para evitar saltos de línea feos */
    .line-clamp-1 {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<div id="catalogModal" class="fixed inset-0 z-[150] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-[#00112b]/90 backdrop-blur-xl transition-opacity duration-500" onclick="closeCatalogModal()"></div>
    
    <div class="relative bg-white w-full max-w-6xl h-[92vh] rounded-[3rem] overflow-hidden flex flex-col shadow-[0_50px_100px_-20px_rgba(0,0,0,0.4)] border border-slate-100">
        
        <div class="relative px-12 py-12 border-b border-slate-50 flex justify-between items-center bg-white z-20 overflow-hidden">
            <div class="absolute top-0 right-0 w-1/3 h-full pointer-events-none opacity-40">
                <div class="absolute right-10 top-0 h-full w-32 bg-slate-50" style="clip-path: polygon(15% 0%, 100% 0%, 85% 100%, 0% 100%);"></div>
            </div>

            <div class="relative z-10">
                <h2 class="text-4xl md:text-5xl font-black text-[#00112b] tracking-tighter leading-none">
                    <span class="text-[#ff0022] italic font-serif font-light">Cursos</span>
                </h2>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.4em] mt-4 flex items-center gap-2">
                    <span class="w-6 h-[1px] bg-slate-200"></span>
                    Selección Académica Profesional
                </p>
            </div>
            
            <button onclick="closeCatalogModal()" class="group relative z-10 flex items-center justify-center w-12 h-12 rounded-full bg-slate-50 transition-all duration-500 hover:bg-[#00112b] shadow-sm">
                <svg class="w-5 h-5 text-[#00112b] group-hover:text-white group-hover:rotate-90 transition-all duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="flex-grow overflow-y-auto custom-scrollbar bg-white relative">
            <div class="sticky top-0 z-30 grid grid-cols-12 px-12 py-5 bg-white/95 backdrop-blur-md border-b border-slate-50 text-[9px] font-black text-slate-300 uppercase tracking-[0.2em]">
                <div class="col-span-1 text-gray-900">Ref.</div>
                <div class="col-span-6 md:col-span-7 text-gray-900">Especialización</div>
                <div class="col-span-2 text-center text-gray-900">Nivel</div>
                <div class="col-span-3 md:col-span-2 text-gray-900 px-4">Ver detalle</div>
            </div>

            <div class="divide-y divide-slate-50 px-8">
                {% for curso in cursos %}
                <div class="group grid grid-cols-12 items-center px-4 py-7 hover:bg-slate-50/80 transition-all duration-500 cursor-pointer rounded-2xl opacity-0 translate-y-[10px]"
                     style="animation: rowFadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; animation-delay: {{ forloop.counter0 }}00ms;"
                     onclick="closeCatalogModal(); cargarDetalleModal('{{ curso.slug }}')">
                    
                    <div class="col-span-1">
                        <span class="text-[10px] font-bold text-slate-200 group-hover:text-[#ff0022] transition-colors italic">#0{{ forloop.counter }}</span>
                    </div>

                    <div class="col-span-6 md:col-span-7 flex items-center gap-6">
                        <div class="hidden sm:block w-12 h-12 rounded-xl overflow-hidden bg-slate-50 border border-slate-100 group-hover:scale-105 transition-transform duration-500">
                            <img src="{{ curso.portada.url }}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700">
                        </div>
                        <div>
                            <h4 class="text-lg font-bold text-[#00112b] tracking-tight leading-tight group-hover:text-[#ff0022] transition-colors">
                                {{ curso.titulo }}
                            </h4>
                            <div class="flex items-center gap-2 mt-1">
                                <svg class="w-3 h-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="2"/></svg>
                                <span class="text-[10px] text-slate-400 font-medium uppercase tracking-tighter">{{ curso.instructor.nombre }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-2 flex justify-center">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter bg-slate-50 px-3 py-1 rounded-md border border-slate-100 group-hover:bg-white transition-all">
                            {{ curso.get_nivel_display }}
                        </span>
                    </div>

                    <div class="col-span-3 md:col-span-2 flex items-center justify-end gap-5">
                        <span class="text-base font-black text-[#00112b] tracking-tighter italic">{{ curso.precio }}</span>
                        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-slate-50 text-slate-400 group-hover:bg-[#00112b] group-hover:text-white transition-all duration-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="px-12 py-8 bg-white border-t border-slate-50 flex justify-between items-center z-20">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-[#ff0022] animate-pulse"></div>
                <span class="text-[10px] font-black text-[#00112b] uppercase tracking-[0.2em]">{{ cursos|length }} Programas Disponibles</span>
            </div>
            <div class="flex items-center gap-8">
                <span class="text-[9px] font-bold text-slate-300 uppercase tracking-widest italic">Cendae Network 2026</span>
            </div>
        </div>
    </div>
</div>

<style>
    /* Animaciones y Scrollbar */
    @keyframes rowFadeIn {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #catalogModal.flex .relative {
        animation: modalScaleUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes modalScaleUp {
        from { opacity: 0; transform: scale(0.99) translateY(10px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .custom-scrollbar::-webkit-scrollbar { width: 3px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #f1f5f9; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
</style>

<script>
// --- FUNCIONES DEL CATÁLOGO ---
function openCatalogModal() {
    const catalogModal = document.getElementById('catalogModal');
    catalogModal.classList.remove('hidden');
    catalogModal.classList.add('flex');
    document.body.style.overflow = 'hidden'; // Bloquea scroll
}

function closeCatalogModal() {
    const catalogModal = document.getElementById('catalogModal');
    catalogModal.classList.add('hidden');
    catalogModal.classList.remove('flex');
    // Solo rehabilitar scroll si el otro modal tampoco está abierto
    if (document.getElementById('cursoModal').classList.contains('hidden')) {
        document.body.style.overflow = 'auto';
    }
}

// --- FUNCIONES DE DETALLE (EXISTENTES MEJORADAS) ---
function cargarDetalleModal(slug) {
    const modal = document.getElementById('cursoModal');
    const el = (id) => document.getElementById(id);

    // Si abrimos un detalle desde el catálogo, aseguramos que el catálogo se cierre primero
    closeCatalogModal();

    fetch(`/cursos/api/curso/${slug}/`)
        .then(response => response.json())
        .then(data => {
            el('modal-titulo').innerText = data.titulo;
            el('modal-descripcion').innerText = data.descripcion;
            el('modal-precio').innerText = `S/ ${data.precio}`;
            el('modal-nivel').innerText = data.detalles.nivel;
            el('modal-instructor-nombre').innerText = data.instructor.nombre;
            el('modal-instructor-cargo').innerText = data.instructor.titulo;
            el('modal-instructor-foto').src = data.instructor.foto;

            const msg = encodeURIComponent(`Hola, solicito información detallada del curso: ${data.titulo}`);
            el('modal-whatsapp').href = `https://wa.me/51942389557?text=${msg}`;

            // Renderizado de Temario
            const container = el('modal-temario');
            container.innerHTML = data.temario.map((modulo, idx) => `
                <div class="accordion-item border border-slate-100 rounded-2xl overflow-hidden transition-all duration-300 hover:shadow-sm">
                    <div onclick="toggleAccordion(this)" 
                         class="py-5 flex justify-between items-center cursor-pointer px-6 hover:bg-slate-50/50 transition-colors group">
                        <div class="flex items-center gap-4">
                            <span class="text-[10px] font-black text-slate-300 group-hover:text-blue-600 transition-colors tracking-tighter">/0${idx + 1}</span>
                            <h4 class="text-xs font-bold text-slate-700 uppercase tracking-tight">${modulo.titulo}</h4>
                        </div>
                        <svg class="w-4 h-4 text-slate-300 transition-transform duration-500 icon-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M19 9l-7 7-7-7"/></svg>
                    </div>
                    <div class="accordion-content max-h-0 overflow-hidden transition-all duration-500 ease-in-out bg-slate-50/30">
                        <div class="pb-6 pl-14 pr-6 pt-2 space-y-3">
                            ${modulo.lecciones.map(lec => `
                                <div class="flex items-center gap-3">
                                    <div class="w-1.5 h-1.5 rounded-full bg-blue-200"></div>
                                    <span class="text-[11px] font-medium text-slate-500 uppercase tracking-tight leading-none">${lec}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        });
}

function toggleAccordion(element) {
    const content = element.nextElementSibling;
    const icon = element.querySelector('.icon-chevron');
    
    document.querySelectorAll('.accordion-content').forEach(other => {
        if (other !== content && other.style.maxHeight) {
            other.style.maxHeight = null;
            const otherIcon = other.parentElement.querySelector('.icon-chevron');
            if(otherIcon) otherIcon.style.transform = 'rotate(0deg)';
        }
    });

    if (content.style.maxHeight) {
        content.style.maxHeight = null;
        icon.style.transform = 'rotate(0deg)';
    } else {
        content.style.maxHeight = content.scrollHeight + "px";
        icon.style.transform = 'rotate(180deg)';
    }
}

function closeModal() {
    const modal = document.getElementById('cursoModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    
    // Solo rehabilitar scroll si el catálogo tampoco está abierto
    if (document.getElementById('catalogModal').classList.contains('hidden')) {
        document.body.style.overflow = 'auto';
    }
}

// Cerrar con tecla ESC
document.addEventListener('keydown', (e) => {
    if (e.key === "Escape") {
        closeModal();
        closeCatalogModal();
    }
});
</script>

